<!DOCTYPE html>
<html>
<head>
    <title>Enhanced WhatsApp Webhook Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #25D366; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #25D366; }
        .stat-label { color: #666; margin-top: 5px; }
        .event { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background: white; }
        .event-header { font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .event-type { background: #25D366; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
        .event-data { background: #f8f9fa; padding: 15px; margin-top: 10px; border-radius: 5px; }
        pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .refresh { background: #25D366; color: white; }
        .clear { background: #dc3545; color: white; }
        .filter { background: #007bff; color: white; }
        .enhanced-features { background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .feature-active { color: #28a745; font-weight: bold; }
        .feature-inactive { color: #6c757d; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #e9ecef; border: none; cursor: pointer; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab.active { background: #25D366; color: white; }
        .tab-content { background: white; padding: 20px; border-radius: 0 8px 8px 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Enhanced WhatsApp Webhook Dashboard</h1>
            <p>Real-time monitoring with advanced features</p>
        </div>
        
        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be loaded dynamically -->
        </div>

        <div class="enhanced-features" id="enhanced-features">
            <h3>üîß Enhanced Features Status</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;" id="features-status">
                <!-- Features status will be loaded dynamically -->
            </div>
        </div>

        <div class="controls">
            <button class="refresh" onclick="location.reload()">üîÑ Refresh</button>
            <button class="clear" onclick="clearEvents()">üóëÔ∏è Clear Events</button>
            <button class="filter" onclick="filterEvents('location_message')">üìç Location Events</button>
            <button class="filter" onclick="filterEvents('incoming_call')">üìû Call Events</button>
            <button class="filter" onclick="filterEvents('poll_created')">üìä Poll Events</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('events')">üìã Recent Events</button>
            <button class="tab" onclick="showTab('locations')">üìç Live Locations</button>
            <button class="tab" onclick="showTab('calls')">üìû Calls</button>
            <button class="tab" onclick="showTab('polls')">üìä Polls</button>
        </div>

        <div id="events" class="tab-content">
            <h3>Recent Events (Last 20)</h3>
            <div id="events-list">
                <!-- Events will be loaded dynamically -->
            </div>
        </div>

        <div id="locations" class="tab-content" style="display: none;">
            <h3>Live Location Trackers</h3>
            <div id="locations-list">
                <!-- Locations will be loaded dynamically -->
            </div>
        </div>

        <div id="calls" class="tab-content" style="display: none;">
            <h3>Active Calls</h3>
            <div id="calls-list">
                <!-- Calls will be loaded dynamically -->
            </div>
        </div>

        <div id="polls" class="tab-content" style="display: none;">
            <h3>Active Polls</h3>
            <div id="polls-list">
                <!-- Polls will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        async function loadDashboardData() {
            try {
                // Load stats
                const statsResponse = await fetch('/stats');
                const stats = await statsResponse.json();
                
                if (stats.success) {
                    updateStats(stats);
                }
                
                // Load recent events
                const eventsResponse = await fetch('/events?limit=20');
                const events = await eventsResponse.json();
                
                if (events.success) {
                    updateEvents(events.events);
                }
                
                // Load live locations
                const locationsResponse = await fetch('/live-locations');
                const locations = await locationsResponse.json();
                
                if (locations.success) {
                    updateLocations(locations.trackers);
                }
                
                // Load calls
                const callsResponse = await fetch('/calls');
                const calls = await callsResponse.json();
                
                if (calls.success) {
                    updateCalls(calls.calls);
                }
                
                // Load polls
                const pollsResponse = await fetch('/polls');
                const polls = await pollsResponse.json();
                
                if (polls.success) {
                    updatePolls(polls.polls);
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        function updateStats(stats) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalEvents}</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.liveLocationTrackers}</div>
                    <div class="stat-label">Live Location Trackers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.activeCalls}</div>
                    <div class="stat-label">Active Calls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.activePolls}</div>
                    <div class="stat-label">Active Polls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.browserTabs}</div>
                    <div class="stat-label">Browser Tabs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.floor(stats.uptime)}</div>
                    <div class="stat-label">Uptime (seconds)</div>
                </div>
            `;
            
            const featuresStatus = document.getElementById('features-status');
            featuresStatus.innerHTML = `
                <div class="${stats.liveLocationTrackers > 0 ? 'feature-active' : 'feature-inactive'}">
                    üìç Live Location Tracking
                </div>
                <div class="${stats.activeCalls > 0 ? 'feature-active' : 'feature-inactive'}">
                    üìû Call Monitoring
                </div>
                <div class="${stats.activePolls > 0 ? 'feature-active' : 'feature-inactive'}">
                    üìä Poll Tracking
                </div>
                <div class="${stats.browserTabs > 0 ? 'feature-active' : 'feature-inactive'}">
                    üåê Browser Lifecycle
                </div>
            `;
        }
        
        function updateEvents(events) {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = events.reverse().map(event => `
                <div class="event">
                    <div class="event-header">
                        <span>${event.timestamp}</span>
                        <span class="event-type">${event.event}</span>
                    </div>
                    <div class="event-data">
                        <pre>${JSON.stringify(event.data, null, 2)}</pre>
                    </div>
                </div>
            `).join('') || '<p>No events available</p>';
        }
        
        function updateLocations(trackers) {
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = trackers.map(tracker => `
                <div class="event">
                    <div class="event-header">
                        <span>Tracker: ${tracker.trackerId}</span>
                        <span class="event-type">ACTIVE</span>
                    </div>
                    <div class="event-data">
                        <pre>${JSON.stringify(tracker, null, 2)}</pre>
                    </div>
                </div>
            `).join('') || '<p>No active live location trackers</p>';
        }
        
        function updateCalls(calls) {
            const callsList = document.getElementById('calls-list');
            callsList.innerHTML = calls.map(call => `
                <div class="event">
                    <div class="event-header">
                        <span>Call: ${call.id}</span>
                        <span class="event-type">${call.status.toUpperCase()}</span>
                    </div>
                    <div class="event-data">
                        <pre>${JSON.stringify(call, null, 2)}</pre>
                    </div>
                </div>
            `).join('') || '<p>No active calls</p>';
        }
        
        function updatePolls(polls) {
            const pollsList = document.getElementById('polls-list');
            pollsList.innerHTML = polls.map(poll => `
                <div class="event">
                    <div class="event-header">
                        <span>Poll: ${poll.pollName || 'Unnamed'}</span>
                        <span class="event-type">${poll.votes ? poll.votes.size : 0} VOTES</span>
                    </div>
                    <div class="event-data">
                        <pre>${JSON.stringify(poll, null, 2)}</pre>
                    </div>
                </div>
            `).join('') || '<p>No active polls</p>';
        }
        
        function clearEvents() {
            if (confirm('Are you sure you want to clear all events?')) {
                fetch('/events', { method: 'DELETE' })
                    .then(() => location.reload());
            }
        }
        
        function filterEvents(eventType) {
            window.location.href = '/events/' + eventType;
        }
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadDashboardData);
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>